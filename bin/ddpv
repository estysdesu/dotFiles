#!/usr/bin/env sh
# vim: syntax=sh

set -e # set -o errexit
set -u # set -o nounset
# set -x # set -o xtrace

function ddpv {
   
    if [ "$1" = '-h' ] || [ "$1" = '--help' ]; then
		printf "%s\n\t%s\n\t%s\n" 'Inputs:' '$1 - the file path to copy from' '$2 - the file path to write to'
		exit 0
    elif [ -z "$1" ]; then
    	printf 'ddpv: ERROR: supply the file path to copy from\n'
		exit 1
    elif [ -z "$2" ]; then
    	printf 'ddpv: ERROR: supply the file path to write to\n'
		exit 1   
	fi

    FILENAME_IN="$1"
    FILENAME_OUT="$2"
	if [ ! -e "$FILENAME_IN" ]; then
		printf "ddpv: ERROR: test -e $FILENAME_IN No such file or directory\n"
		exit 1
	elif [ ! -e "$FILENAME_OUT" ]; then
		printf "ddpv: ERROR: test -e $FILENAME_OUT No such file or directory\n"
		exit 1
    fi

	SIZE=$(stat --format=%s "$FILENAME_IN")
	if [ -z "$3" ]; then
		SIZE="$3"
	fi
    
	if [ "$(id -u)" -ne 0 ]; then
		printf "ddpv: WARNING: running as $(id -un); writing to some locations may require elevated priveleges\n"
	fi
	##### SIZE #####
	dd if="$FILENAME_IN" count="$SIZE" | pv -s "$SIZE" | dd of="$FILENAME_OUT"; sync
}

ddpv "$@"
